---
name: Droid CI Fix

on:
  workflow_run:
    workflows: ["Validate"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "factory-droid[bot]"
          git config user.email "138933559+factory-droid[bot]@users.noreply.github.com"

      - name: Fetch CI failure logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > ci-failure.log 2>&1 || true

      - name: Auto-fix CI failures
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > prompt.txt << 'EOF'
          You are an automated CI fixer for a Kubernetes/GitOps homelab repository.

          The CI workflow failed. Analyze the failure and fix it.

          CI failure log is in: ci-failure.log

          Common issues to fix:
          1. YAML syntax errors (trailing spaces, indentation, invalid characters)
          2. Kubeconform validation failures (wrong API versions, missing fields)
          3. Flux local validation errors (missing dependencies, wrong paths)
          4. SOPS encryption issues

          Steps:
          1. Read ci-failure.log to understand what failed
          2. Identify the problematic file(s)
          3. Read the file(s) and fix the issue
          4. Commit and push the fix

          Use git to commit changes with message format:
          "fix(ci): <description of fix>

          Co-authored-by: factory-droid[bot] <138933559+factory-droid[bot]@users.noreply.github.com>"

          Push to: ${{ github.event.workflow_run.head_branch }}

          Only make minimal changes to fix the CI failure. Do not refactor or improve code.
          EOF

          droid exec --auto high -f prompt.txt

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: droid-fix-debug-${{ github.run_id }}
          path: |
            prompt.txt
            ci-failure.log
          retention-days: 7
