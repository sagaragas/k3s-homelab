---
name: Droid PR Gatekeeper

on:
  workflow_run:
    workflows: [Validate]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  gatekeeper:
    name: Review and Merge
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Find associated PR
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Skip if this was a push to main (not a PR)
          if [ "$BRANCH" = "main" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find open PR for this branch
          PR_JSON=$(gh pr list --repo "${{ github.repository }}" \
            --head "$BRANCH" --state open --json number,author,title,labels --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for branch $BRANCH"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].author.login')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(",")')
          IS_BOT=$(echo "$PR_JSON" | jq -r '.[0].author.is_bot')

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_labels=$PR_LABELS" >> $GITHUB_OUTPUT
          echo "is_bot=$IS_BOT" >> $GITHUB_OUTPUT

          echo "Found PR #$PR_NUMBER: $PR_TITLE (by $PR_AUTHOR, bot=$IS_BOT)"

      - name: Checkout repository
        if: steps.find-pr.outputs.skip != 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Install Droid CLI
        if: steps.find-pr.outputs.skip != 'true'
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Classify PR
        if: steps.find-pr.outputs.skip != 'true'
        id: classify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_TITLE="${{ steps.find-pr.outputs.pr_title }}"
          PR_AUTHOR="${{ steps.find-pr.outputs.pr_author }}"
          IS_BOT="${{ steps.find-pr.outputs.is_bot }}"

          # Trusted bot authors that get auto-merge
          TRUSTED_BOTS="renovate[bot] dependabot[bot] factory-droid[bot] app/renovate"
          IS_TRUSTED="false"
          for bot in $TRUSTED_BOTS; do
            if [ "$PR_AUTHOR" = "$bot" ]; then
              IS_TRUSTED="true"
              break
            fi
          done

          # Critical infrastructure -- never auto-merge, even from bots
          IS_CRITICAL="false"
          if echo "$PR_TITLE" | grep -qiE '(talos|cilium|postgres.*major|etcd|ceph)'; then
            IS_CRITICAL="true"
          fi

          echo "is_trusted=$IS_TRUSTED" >> $GITHUB_OUTPUT
          echo "is_critical=$IS_CRITICAL" >> $GITHUB_OUTPUT
          echo "Classification: trusted=$IS_TRUSTED, critical=$IS_CRITICAL, bot=$IS_BOT"

      - name: Droid review and decide
        if: steps.find-pr.outputs.skip != 'true'
        id: droid-review
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"
          IS_TRUSTED="${{ steps.classify.outputs.is_trusted }}"
          IS_CRITICAL="${{ steps.classify.outputs.is_critical }}"

          # Get the PR diff
          gh pr diff "$PR_NUMBER" --repo "${{ github.repository }}" > pr-diff.txt 2>&1 || true

          # Build the review prompt
          cat > review-prompt.txt << PROMPT
          You are a Kubernetes/GitOps expert reviewing PR #${PR_NUMBER} in a homelab cluster repository.

          ## PR Info
          - Title: ${{ steps.find-pr.outputs.pr_title }}
          - Author: ${{ steps.find-pr.outputs.pr_author }}
          - Labels: ${{ steps.find-pr.outputs.pr_labels }}
          - Trusted bot: ${IS_TRUSTED}
          - Critical infrastructure: ${IS_CRITICAL}

          ## Diff
          The PR diff is in: pr-diff.txt

          ## Your Task

          1. Read pr-diff.txt carefully
          2. Check for:
             - Breaking changes (API version changes, removed fields, port changes)
             - Security issues (exposed secrets, removed security contexts, privilege escalation)
             - Configuration errors (wrong image tags, typos in hostnames, invalid YAML references)
             - Resource issues (missing limits, unreasonable sizes)
          3. Make a decision and output EXACTLY one of these lines as the LAST line of your response:
             - DECISION: APPROVE -- if the changes look safe
             - DECISION: REJECT -- if you found real problems (explain above)
             - DECISION: FLAG -- if this needs human attention (critical infra, risky changes)

          Be pragmatic. Dependency version bumps from Renovate are almost always safe.
          Focus on real bugs and breaking changes, not style.
          PROMPT

          # Run droid review
          REVIEW_OUTPUT=$(droid exec --skip-permissions-unsafe \
            -m claude-opus-4-6 -r max \
            -f review-prompt.txt 2>&1) || true

          echo "$REVIEW_OUTPUT"

          # Extract decision from last lines
          DECISION=$(echo "$REVIEW_OUTPUT" | grep -oE 'DECISION: (APPROVE|REJECT|FLAG)' | tail -1 | awk '{print $2}')

          if [ -z "$DECISION" ]; then
            echo "Could not extract decision, defaulting to FLAG"
            DECISION="FLAG"
          fi

          echo "decision=$DECISION" >> $GITHUB_OUTPUT

          # Save review for the comment
          echo "$REVIEW_OUTPUT" > review-output.txt
          echo "Droid decision: $DECISION"

      - name: Act on decision
        if: steps.find-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"
          PR_TITLE="${{ steps.find-pr.outputs.pr_title }}"
          PR_AUTHOR="${{ steps.find-pr.outputs.pr_author }}"
          DECISION="${{ steps.droid-review.outputs.decision }}"
          IS_TRUSTED="${{ steps.classify.outputs.is_trusted }}"
          IS_CRITICAL="${{ steps.classify.outputs.is_critical }}"

          # Truncate review for comment (max 64k chars for GH comments)
          REVIEW_BODY=$(head -c 60000 review-output.txt)

          case "$DECISION" in
            APPROVE)
              if [ "$IS_CRITICAL" = "true" ]; then
                # Critical infra -- flag even if approved
                gh pr comment "$PR_NUMBER" --body "## Droid Gatekeeper: Approved (Critical Infra -- manual merge required)

          ${REVIEW_BODY}

          ---
          CI passed and changes look safe, but this touches critical infrastructure. Leaving for human merge."

                echo "Critical infra PR approved but not auto-merged"

              elif [ "$IS_TRUSTED" = "true" ]; then
                # Trusted bot + approved = auto-merge
                # Note: skipping gh pr review --approve because GITHUB_TOKEN is not
                # permitted to approve PRs by default. Merge directly instead.
                gh pr comment "$PR_NUMBER" --body "## Droid Gatekeeper: Approved -- auto-merging

          ${REVIEW_BODY}"
                gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
                  gh pr merge "$PR_NUMBER" --squash --delete-branch || \
                  echo "Merge failed -- may need manual intervention"

                # Discord notification
                curl -s -H "Content-Type: application/json" \
                  -d "{\"embeds\":[{\"title\":\"Merged PR #${PR_NUMBER}\",\"description\":\"**${PR_TITLE}**\nby ${PR_AUTHOR}\n\nAuto-reviewed and merged by Droid Gatekeeper.\",\"color\":3066993,\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
                  "$DISCORD_WEBHOOK" || true

                echo "Trusted bot PR auto-merged"

              else
                # Human PR -- approve but don't merge
                gh pr comment "$PR_NUMBER" --body "## Droid Gatekeeper: Approved

          ${REVIEW_BODY}

          ---
          CI passed, review looks good. Ready for you to merge."

                echo "Human PR approved, not auto-merged"
              fi
              ;;

            REJECT)
              gh pr comment "$PR_NUMBER" --body "## Droid Gatekeeper: Issues Found

          ${REVIEW_BODY}

          ---
          Found problems in this PR. Please address the issues above."

              # Discord notification for rejected PRs
              curl -s -H "Content-Type: application/json" \
                -d "{\"embeds\":[{\"title\":\"PR #${PR_NUMBER} flagged\",\"description\":\"**${PR_TITLE}**\nby ${PR_AUTHOR}\n\nDroid found issues. Check PR comments.\",\"color\":15158332,\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
                "$DISCORD_WEBHOOK" || true

              echo "PR rejected by droid review"
              ;;

            FLAG)
              gh pr comment "$PR_NUMBER" --body "## Droid Gatekeeper: Needs Human Review

          ${REVIEW_BODY}

          ---
          This PR needs human attention before merging."

              echo "PR flagged for human review"
              ;;
          esac

      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: gatekeeper-debug-${{ github.run_id }}
          path: |
            review-prompt.txt
            review-output.txt
            pr-diff.txt
          retention-days: 7
