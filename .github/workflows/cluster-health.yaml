name: Cluster Health Report

on:
  schedule:
    - cron: '0 8 * * 1'  # Monday 8am UTC
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Cluster Health Report
        id: health
        run: |
          echo "## Cluster Health Report" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Nodes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get nodes -o wide >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Unhealthy Pods" >> $GITHUB_STEP_SUMMARY
          UNHEALTHY=$(kubectl get pods -A --field-selector=status.phase!=Running,status.phase!=Succeeded 2>/dev/null | grep -v "^NAMESPACE" || echo "None")
          if [ "$UNHEALTHY" = "None" ] || [ -z "$UNHEALTHY" ]; then
            echo "All pods healthy! ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$UNHEALTHY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Flux Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ks -A 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### HelmRelease Status" >> $GITHUB_STEP_SUMMARY
          FAILED_HR=$(kubectl get hr -A 2>/dev/null | grep -v "True" | grep -v "READY" || echo "")
          if [ -z "$FAILED_HR" ]; then
            echo "All HelmReleases healthy! ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$FAILED_HR" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Storage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -A 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "### Image Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get deploy -n default -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.template.spec.containers[0].image}{"\n"}{end}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for issues and notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          ISSUES=0
          ISSUE_LIST=""
          
          # Check for non-ready nodes
          NOT_READY=$(kubectl get nodes | grep -v "Ready" | grep -v "NAME" || true)
          if [ -n "$NOT_READY" ]; then
            echo "::warning::Some nodes are not ready"
            ISSUES=$((ISSUES+1))
            ISSUE_LIST="$ISSUE_LIST\n- Nodes not ready"
          fi
          
          # Check for failed HelmReleases
          FAILED=$(kubectl get hr -A 2>/dev/null | grep -E "False|Unknown" | grep -v "READY" || true)
          if [ -n "$FAILED" ]; then
            echo "::warning::Some HelmReleases are not ready"
            ISSUES=$((ISSUES+1))
            ISSUE_LIST="$ISSUE_LIST\n- HelmReleases failing"
          fi
          
          # Check for unhealthy pods
          UNHEALTHY=$(kubectl get pods -A --field-selector=status.phase=Failed 2>/dev/null | grep -v "NAMESPACE" || true)
          if [ -n "$UNHEALTHY" ]; then
            echo "::warning::Some pods are in failed state"
            ISSUES=$((ISSUES+1))
            ISSUE_LIST="$ISSUE_LIST\n- Pods in failed state"
          fi
          
          # Count resources
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          POD_COUNT=$(kubectl get pods -A --no-headers | wc -l)
          HR_COUNT=$(kubectl get hr -A --no-headers 2>/dev/null | wc -l)
          
          # Send Discord notification
          if [ $ISSUES -gt 0 ]; then
            COLOR=15158332  # Red
            TITLE="⚠️ Weekly Health Report - Issues Found"
            DESC="Found **$ISSUES** potential issues:$ISSUE_LIST"
          else
            COLOR=3066993  # Green
            TITLE="✅ Weekly Health Report - All Healthy"
            DESC="Cluster is operating normally"
          fi
          
          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESC\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Nodes\", \"value\": \"$NODE_COUNT\", \"inline\": true},
                  {\"name\": \"Pods\", \"value\": \"$POD_COUNT\", \"inline\": true},
                  {\"name\": \"HelmReleases\", \"value\": \"$HR_COUNT\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"View full report in GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
          
          if [ $ISSUES -gt 0 ]; then
            echo "Found $ISSUES potential issues"
          else
            echo "Cluster is healthy!"
          fi
