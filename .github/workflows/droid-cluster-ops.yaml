---
name: Droid Cluster Ops

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch: # Manual trigger

concurrency:
  group: droid-cluster-ops
  cancel-in-progress: false

jobs:
  cluster-ops:
    name: Autonomous Cluster Management
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Configure git identity
        run: |
          git config user.name "factory-droid[bot]"
          git config user.email "138933559+factory-droid[bot]@users.noreply.github.com"

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Collect cluster state
        run: |
          {
            echo "=== CLUSTER STATE SNAPSHOT ==="
            echo "Timestamp: $(date -u)"
            echo ""

            echo "=== NODES ==="
            kubectl get nodes -o wide 2>&1 || echo "ERROR: Failed to get nodes"
            echo ""

            echo "=== NODE CONDITIONS ==="
            kubectl get nodes -o json 2>&1 | jq -r '
              .items[] |
              .metadata.name as $name |
              .status.conditions[] |
              select(.status != "False" and .type != "Ready") // empty |
              "\($name): \(.type)=\(.status) \(.message // "")"
            ' 2>&1 || true
            echo ""

            echo "=== UNHEALTHY PODS ==="
            kubectl get pods -A --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers 2>&1 || echo "None"
            echo ""

            echo "=== POD RESTARTS (>5) ==="
            kubectl get pods -A -o json 2>&1 | jq -r '
              .items[] |
              select(.status.containerStatuses != null) |
              .status.containerStatuses[] |
              select(.restartCount > 5) |
              "\(.name) in \(.state | keys[0]) - restarts: \(.restartCount)"
            ' 2>&1 || true
            echo ""

            echo "=== HELMRELEASES ==="
            kubectl get hr -A 2>&1 || echo "ERROR: Failed to get HelmReleases"
            echo ""

            echo "=== FAILED HELMRELEASES (detail) ==="
            kubectl get hr -A -o json 2>&1 | jq -r '
              .items[] |
              select(.status.conditions[]? | select(.type == "Ready" and .status != "True")) |
              "HR: \(.metadata.namespace)/\(.metadata.name) - \(.status.conditions[] | select(.type == "Ready") | .message)"
            ' 2>&1 || true
            echo ""

            echo "=== FLUX KUSTOMIZATIONS ==="
            kubectl get ks -A 2>&1 || echo "ERROR: Failed to get Kustomizations"
            echo ""

            echo "=== FAILED KUSTOMIZATIONS (detail) ==="
            kubectl get ks -A -o json 2>&1 | jq -r '
              .items[] |
              select(.status.conditions[]? | select(.type == "Ready" and .status != "True")) |
              "KS: \(.metadata.namespace)/\(.metadata.name) - \(.status.conditions[] | select(.type == "Ready") | .message)"
            ' 2>&1 || true
            echo ""

            echo "=== RECENT WARNING EVENTS ==="
            kubectl get events -A --sort-by='.lastTimestamp' --field-selector type=Warning 2>&1 | tail -30 || true
            echo ""

            echo "=== PVC USAGE ==="
            kubectl get pvc -A --no-headers 2>&1 || true
            echo ""

            echo "=== CERTIFICATES ==="
            kubectl get certificates -A 2>&1 || echo "No certificates found"
            echo ""

            echo "=== FLUX SOURCES ==="
            kubectl get gitrepo -A 2>&1 || true
            kubectl get helmrepo -A 2>&1 || true
            echo ""

            echo "=== IMAGE VERSIONS (default namespace) ==="
            kubectl get deploy -n default -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.template.spec.containers[0].image}{"\n"}{end}' 2>&1 || true
            echo ""

          } > cluster-state.txt

          echo "Cluster state collected:"
          wc -l cluster-state.txt

      - name: Build droid prompt
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat > prompt.txt << 'PROMPT'
          You are an autonomous Kubernetes cluster operator for the Ragas homelab.
          Your job is to monitor, diagnose, and fix cluster issues.

          ## Environment

          - You have full kubectl access to the live cluster
          - You have full git/gh access to this repository (the GitOps source of truth)
          - You have the flux CLI available
          - Discord webhook is in the DISCORD_WEBHOOK environment variable
          - Cluster state snapshot is in: cluster-state.txt
          - You are running from the repository root with all manifests available

          ## Cluster Context

          - OS: Talos Linux (no SSH, use talosctl if needed)
          - GitOps: Flux v2 - all persistent changes MUST go through git
          - CNI: Cilium
          - Ingress: Envoy Gateway
          - Internal domain: *.ragas.cc (envoy-internal at 172.16.1.61)
          - Secrets: SOPS + age encrypted
          - Storage: CephFS for app configs, Ceph RBD for databases, NFS for media

          ## Instructions

          1. Read cluster-state.txt thoroughly
          2. Identify any issues (unhealthy pods, failed HelmReleases, failed Kustomizations,
             node problems, certificate issues, high restart counts, warning events)
          3. For each issue found, take action:

          ### Runtime fixes (apply directly via kubectl)
          - Restart crashlooping pods: `kubectl delete pod <name> -n <ns>`
          - Unstick HelmReleases: `flux suspend hr <name> -n <ns> && flux resume hr <name> -n <ns>`
          - Force reconciliation: `flux reconcile ks <name> -n <ns> --with-source`
          - Restart stuck deployments: `kubectl rollout restart deploy/<name> -n <ns>`

          ### Manifest fixes (create a PR)
          - If the issue is caused by a wrong value in a YAML manifest (bad image tag,
            wrong port, missing env var, incorrect resource limits), fix the file and
            create a PR:
            ```
            git checkout -b fix/droid-ops-$(date +%s)
            # make changes
            git add -A
            git commit -m "fix(<app>): <description>

            Detected by autonomous cluster ops.

            Co-authored-by: factory-droid[bot] <138933559+factory-droid[bot]@users.noreply.github.com>"
            git push -u origin HEAD
            gh pr create --base main --fill
            ```

          ### Cannot fix (create an issue)
          - If the problem requires human intervention (hardware failure, external service
            down, needs credentials rotation, storage capacity), create a GitHub issue:
            ```
            gh issue create --title "Cluster: <summary>" --body "<diagnosis details>"
            ```

          4. After all actions, send a Discord notification summarizing what you found and did:
             ```
             curl -s -H "Content-Type: application/json" \
               -d '{"embeds":[{"title":"<title>","description":"<summary>","color":<color>,"timestamp":"<iso8601>"}]}' \
               "$DISCORD_WEBHOOK"
             ```
             Use color 3066993 (green) for all-healthy, 16776960 (yellow) for issues fixed,
             15158332 (red) for issues that need human attention.

          5. If the cluster is completely healthy, just send a short green Discord message
             and exit. Don't create issues or PRs for a healthy cluster.

          ## Safety Rules
          - Never delete namespaces
          - Never delete PVCs or PVs
          - Never drain nodes
          - Never modify SOPS-encrypted secrets (you don't have the age key)
          - Never force-push to main
          - Always create PRs for manifest changes, never push directly to main
          PROMPT

      - name: Run Droid Cluster Ops
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          KUBECONFIG: /home/runner/.kube/config
        run: |
          droid exec --skip-permissions-unsafe \
            -m claude-opus-4-6 -r max \
            -f prompt.txt

      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: droid-ops-debug-${{ github.run_id }}
          path: |
            prompt.txt
            cluster-state.txt
          retention-days: 7
