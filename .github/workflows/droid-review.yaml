---
name: Droid Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: droid-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "factory-droid[bot]"
          git config user.email "138933559+factory-droid[bot]@users.noreply.github.com"

      - name: Perform automated code review
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > prompt.txt << 'EOF'
          You are reviewing a Kubernetes/GitOps homelab repository.

          First, fetch the PR context from: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}

          Focus on these Kubernetes/Flux-specific issues:
          - Invalid YAML syntax
          - Missing required fields in Kubernetes resources
          - Incorrect API versions
          - HelmRelease misconfigurations (wrong chart versions, invalid values)
          - Kustomization errors (missing resources, wrong paths)
          - SOPS encryption issues
          - Security issues (hardcoded secrets, missing security contexts)
          - Resource limits/requests problems
          - Namespace mismatches
          - Dependency ordering issues in Flux

          Skip commenting on:
          - Style preferences
          - Minor optimizations
          - Documentation

          Use GitHub CLI to submit your review. PR number is ${{ github.event.pull_request.number }}.
          Submit at most 5 comments, prioritizing critical issues.
          EOF

          droid exec --auto high -f prompt.txt
