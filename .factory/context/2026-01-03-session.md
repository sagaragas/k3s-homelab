# Session Log: 2026-01-03

> **Purpose:** Context for future Droid sessions. Read relevant sections as needed.

---

## Quick Summary

Migrated Homepage and Bazarr from Runtipi to K8s. Cleaned up repo, improved agentic docs. Established migration patterns for Docker/LXC → K8s.

---

## Section: Infrastructure State

### K8s Services (on ragas.cc)
| Service | URL | Status |
|---------|-----|--------|
| Homepage | home.ragas.cc | ✅ Deployed |
| Bazarr | bazarr.ragas.cc | ✅ Deployed |
| Grafana | grafana.ragas.cc | ✅ Existing |
| Prometheus | prometheus.ragas.cc | ✅ Existing |

### Pending Migrations (from Runtipi 172.16.1.7)
| Service | Data | Notes |
|---------|------|-------|
| Speedtest Tracker | 51MB postgres | Need postgres sidecar |
| Overseerr | Config only | Has public domain request.ragas.sh |
| NextGBA | Minimal | Static files |

### Key IPs
- envoy-internal: 172.16.1.61 (all internal K8s HTTPRoutes)
- bind9 DNS: 172.16.1.10
- Runtipi: 172.16.1.7
- arr LXC: 172.16.1.31
- NAS: 172.16.1.250

---

## Section: Completed Work

### 1. Homepage Migration
- Moved from Runtipi to K8s
- Custom cyberpunk theme with CSS
- Title: "Sagar's Homelab"
- Widgets: search, weather, kubernetes
- Ping indicators for all services
- Config in helmrelease.yaml values (not external configmap)

### 2. Bazarr Migration
- Used bjw-s/app-template:3.6.1 chart
- Config restored from Runtipi via tar backup
- Fixed base_url from `/bazarr.ragas.sh/` to `/`
- NFS media mount DISABLED (NAS doesn't allow K8s workers yet)
- DNS updated in bind9

### 3. Repo Cleanup
Deleted unused template directories:
- `ansible/` - Not used (Talos, not Ansible)
- `terraform/` - Not used
- `templates/` - One-time bootstrap
- `.venv/`, `.pytest_cache/` - Build artifacts

### 4. Agentic Docs
- Updated `AGENTS.md` with full service inventory
- Created `.factory/skills/migrate-service/SKILL.md`
- Updated `.factory/droids/homelab-ops.yaml`

### 5. Security Audit
- Confirmed secrets NOT in git
- Talos configs in `.gitignore`
- All sensitive files properly ignored
- SOPS encryption for K8s secrets

---

## Section: Patterns Established

### App Deployment Pattern
```
kubernetes/apps/default/<app>/
├── app/
│   ├── helmrelease.yaml    # bjw-s/app-template
│   ├── httproute.yaml      # Gateway API
│   └── kustomization.yaml
└── ks.yaml                 # Flux Kustomization
```

### Config Migration Pattern
```bash
# 1. Backup from source
ssh root@172.16.1.7 "tar -czf /tmp/<app>.tar.gz -C /path/to/config ."
scp root@172.16.1.7:/tmp/<app>.tar.gz /tmp/

# 2. Deploy K8s app (push to git, wait for pod)

# 3. Copy config to pod
scp /tmp/<app>.tar.gz root@172.16.1.9:/tmp/
# On ansible node:
POD=$(kubectl get pod -n default -l app.kubernetes.io/name=<app> -o jsonpath="{.items[0].metadata.name}")
kubectl cp /tmp/<app>.tar.gz default/$POD:/tmp/
kubectl exec $POD -- tar -xzf /tmp/<app>.tar.gz -C /config

# 4. Fix base_url if needed
kubectl exec $POD -- sed -i 's|base_url:.*|base_url: /|' /config/config.yaml

# 5. Restart pod
kubectl delete pod $POD

# 6. Update DNS (on 172.16.1.10)
# Change A record to 172.16.1.61, increment serial, reload bind9
```

### DNS Update Pattern
```bash
ssh root@172.16.1.10
vim /etc/bind/db.ragas.cc
# Update A record, increment serial
systemctl reload bind9
```

---

## Section: Domain Rules

### CRITICAL - Public Domains (DO NOT CHANGE)
- `request.ragas.sh` → Overseerr (public requests)
- `plex.ragas.sh` → Plex
- `jelly.ragas.sh` → Jellyfin

### Internal Domain
- All internal services use `*.ragas.cc`
- Resolved via bind9 (172.16.1.10) → AdGuard

### Migration Domain Changes
- Old configs may have `base_url: /app.ragas.sh/`
- Change to `base_url: /` when migrating

---

## Section: Known Issues

### NFS Media Mount
- NAS (172.16.1.250) doesn't allow K8s workers
- Workers: 172.16.1.50-53
- Apps can still use API connections (Sonarr/Radarr)
- TODO: Configure NAS NFS allowed hosts

### HTTPRoute Service Names
- bjw-s app-template creates service named `<app>`, not `<app>-app`
- HTTPRoute backendRef must match

### Flux Reconciliation
- Push to main auto-deploys
- Force sync: `flux reconcile ks <app> -n <ns> --with-source`
- Check status: `flux get hr -A`

---

## Section: Pending Tasks

1. **Speedtest Tracker Migration**
   - Has 51MB postgres data
   - Need postgres sidecar or CloudNative-PG
   - Located: /root/runtipi/app-data/migrated/speedtest-tracker/

2. **Overseerr Migration**
   - Has public domain (request.ragas.sh) - handle carefully
   - May need dual routing (public + internal)

3. **NAS NFS Configuration**
   - Add K8s workers to allowed hosts
   - IPs: 172.16.1.50, .51, .52, .53
   - Then re-enable NFS mounts in Bazarr, etc.

4. **arr Stack Consideration**
   - Currently on arr LXC (172.16.1.31)
   - Could migrate Sonarr, Radarr, Prowlarr to K8s
   - Would centralize management

---

## Section: Commands Reference

```bash
# K8s via ansible node (172.16.1.9)
ssh root@172.16.1.9 "kubectl get pods -A"

# Flux commands
flux get ks -A
flux get hr -A
flux reconcile ks <app> -n <ns> --with-source

# Talos (NO SSH)
talosctl --nodes 172.16.1.50 health
talosctl --nodes 172.16.1.50 dashboard

# SOPS
sops --encrypt --in-place secret.sops.yaml
sops --decrypt secret.sops.yaml

# Git workflow
cd /root/homelab/k3s
git add -A && git commit -m "feat: description" && git push origin main
```

---

## Section: File Locations

| Item | Path |
|------|------|
| K8s manifests | /root/homelab/k3s/kubernetes/apps/ |
| Flux config | /root/homelab/k3s/kubernetes/flux/ |
| Talos config | /root/homelab/k3s/talos/ |
| Skills | /root/homelab/k3s/.factory/skills/ |
| Droids | /root/homelab/k3s/.factory/droids/ |
| bind9 zone | /etc/bind/db.ragas.cc (on 172.16.1.10) |
| Runtipi data | /root/runtipi/app-data/migrated/ (on 172.16.1.7) |
