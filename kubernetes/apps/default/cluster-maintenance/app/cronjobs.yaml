---
# Weekly cleanup of completed pods/jobs
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup-completed-pods
spec:
  schedule: "0 4 * * 0"  # Sunday 4am
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-maintenance
          restartPolicy: OnFailure
          containers:
            - name: kubectl
              image: bitnami/kubectl:latest
              envFrom:
                - secretRef:
                    name: cluster-maintenance-discord
              command:
                - /bin/sh
                - -c
                - |
                  echo "Cleaning up completed pods..."
                  PODS_DELETED=$(kubectl delete pods --all-namespaces --field-selector=status.phase==Succeeded 2>&1 | grep -c "deleted" || echo "0")
                  FAILED_DELETED=$(kubectl delete pods --all-namespaces --field-selector=status.phase==Failed --ignore-not-found 2>&1 | grep -c "deleted" || echo "0")

                  echo "Cleaning up old replicasets..."
                  RS_DELETED=0
                  kubectl get rs --all-namespaces -o json | \
                    jq -r '.items[] | select(.spec.replicas==0) | "\(.metadata.namespace) \(.metadata.name)"' | \
                    while read ns name; do
                      kubectl delete rs "$name" -n "$ns" --ignore-not-found
                      RS_DELETED=$((RS_DELETED+1))
                    done

                  # Send Discord notification
                  curl -s -H "Content-Type: application/json" \
                    -d "{\"embeds\":[{\"title\":\"üßπ Weekly Cleanup Complete\",\"color\":3066993,\"fields\":[{\"name\":\"Completed Pods\",\"value\":\"$PODS_DELETED deleted\",\"inline\":true},{\"name\":\"Failed Pods\",\"value\":\"$FAILED_DELETED deleted\",\"inline\":true},{\"name\":\"Stale ReplicaSets\",\"value\":\"Cleaned\",\"inline\":true}],\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
                    "$DISCORD_WEBHOOK"

                  echo "Cleanup complete!"
---
# Daily health check - restart unhealthy pods
apiVersion: batch/v1
kind: CronJob
metadata:
  name: health-check-restart
spec:
  schedule: "0 5 * * *"  # Daily 5am
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-maintenance
          restartPolicy: OnFailure
          containers:
            - name: kubectl
              image: bitnami/kubectl:latest
              envFrom:
                - secretRef:
                    name: cluster-maintenance-discord
              command:
                - /bin/sh
                - -c
                - |
                  ISSUES_FOUND=0
                  ACTIONS=""

                  echo "Checking for CrashLoopBackOff pods..."
                  CRASH_PODS=$(kubectl get pods --all-namespaces | grep CrashLoopBackOff | awk '{print $1"/"$2}' || true)
                  if [ -n "$CRASH_PODS" ]; then
                    echo "$CRASH_PODS" | while read pod; do
                      ns=$(echo $pod | cut -d'/' -f1)
                      name=$(echo $pod | cut -d'/' -f2)
                      kubectl delete pod "$name" -n "$ns" --ignore-not-found
                    done
                    ISSUES_FOUND=$((ISSUES_FOUND + $(echo "$CRASH_PODS" | wc -l)))
                    ACTIONS="$ACTIONS\n- Restarted CrashLoopBackOff pods"
                  fi

                  echo "Checking for stuck ImagePullBackOff pods..."
                  PULL_PODS=$(kubectl get pods --all-namespaces | grep ImagePullBackOff | awk '{print $1"/"$2}' || true)
                  if [ -n "$PULL_PODS" ]; then
                    echo "$PULL_PODS" | while read pod; do
                      ns=$(echo $pod | cut -d'/' -f1)
                      name=$(echo $pod | cut -d'/' -f2)
                      kubectl delete pod "$name" -n "$ns" --ignore-not-found
                    done
                    ISSUES_FOUND=$((ISSUES_FOUND + $(echo "$PULL_PODS" | wc -l)))
                    ACTIONS="$ACTIONS\n- Deleted ImagePullBackOff pods"
                  fi

                  # Only notify if issues were found
                  if [ $ISSUES_FOUND -gt 0 ]; then
                    curl -s -H "Content-Type: application/json" \
                      -d "{\"embeds\":[{\"title\":\"üîÑ Health Check - Issues Fixed\",\"color\":16776960,\"description\":\"Found and fixed $ISSUES_FOUND unhealthy pods$ACTIONS\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
                      "$DISCORD_WEBHOOK"
                  fi

                  echo "Health check complete! Issues found: $ISSUES_FOUND"
---
# Weekly Flux garbage collection
apiVersion: batch/v1
kind: CronJob
metadata:
  name: flux-gc
spec:
  schedule: "0 3 * * 0"  # Sunday 3am
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cluster-maintenance
          restartPolicy: OnFailure
          containers:
            - name: kubectl
              image: bitnami/kubectl:latest
              envFrom:
                - secretRef:
                    name: cluster-maintenance-discord
              command:
                - /bin/sh
                - -c
                - |
                  echo "Cleaning up old Helm secrets..."
                  SECRETS_DELETED=0
                  for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}'); do
                    DELETED=$(kubectl get secrets -n "$ns" -l owner=helm --sort-by=.metadata.creationTimestamp 2>/dev/null | \
                      grep "sh.helm.release" | head -n -3 | awk '{print $1}' | \
                      xargs -r kubectl delete secret -n "$ns" --ignore-not-found 2>&1 | grep -c "deleted" || echo "0")
                    SECRETS_DELETED=$((SECRETS_DELETED + DELETED))
                  done

                  # Send Discord notification
                  curl -s -H "Content-Type: application/json" \
                    -d "{\"embeds\":[{\"title\":\"üóëÔ∏è Flux GC Complete\",\"color\":9807270,\"description\":\"Cleaned up $SECRETS_DELETED old Helm release secrets\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
                    "$DISCORD_WEBHOOK"

                  echo "Flux GC complete! Deleted $SECRETS_DELETED secrets"
