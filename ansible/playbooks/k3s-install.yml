---
- name: Prepare all k3s nodes
  hosts: k3s_cluster
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - curl
          - open-iscsi
          - nfs-common
          - jq
        state: present

    - name: Enable and start iscsid
      systemd:
        name: iscsid
        enabled: yes
        state: started

    - name: Disable swap
      command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '\sswap\s'
        state: absent

- name: Install k3s on first server (init cluster)
  hosts: k3s_servers
  become: true
  serial: 1
  tasks:
    - name: Check if k3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install k3s on init server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - server \
          --cluster-init \
          --token="{{ k3s_token }}" \
          --tls-san="{{ k3s_vip }}" \
          --tls-san="{{ ansible_host }}" \
          --disable=traefik \
          --disable=servicelb \
          --flannel-backend=vxlan \
          --cluster-cidr="{{ cluster_cidr }}" \
          --service-cidr="{{ service_cidr }}" \
          --cluster-dns="{{ cluster_dns }}" \
          --write-kubeconfig-mode=644
      when:
        - k3s_server_init | default(false)
        - not k3s_binary.stat.exists

    - name: Wait for first server to be ready
      command: kubectl get nodes
      register: nodes
      until: nodes.rc == 0
      retries: 30
      delay: 10
      when: k3s_server_init | default(false)

    - name: Install k3s on additional servers
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - server \
          --server="https://{{ hostvars['k3s-cp-1']['ansible_host'] }}:6443" \
          --token="{{ k3s_token }}" \
          --tls-san="{{ k3s_vip }}" \
          --tls-san="{{ ansible_host }}" \
          --disable=traefik \
          --disable=servicelb \
          --flannel-backend=vxlan \
          --cluster-cidr="{{ cluster_cidr }}" \
          --service-cidr="{{ service_cidr }}" \
          --cluster-dns="{{ cluster_dns }}" \
          --write-kubeconfig-mode=644
      when:
        - not k3s_server_init | default(false)
        - not k3s_binary.stat.exists

- name: Install k3s agents
  hosts: k3s_agents
  become: true
  tasks:
    - name: Check if k3s-agent is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install k3s agent
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - agent \
          --server="https://{{ hostvars['k3s-cp-1']['ansible_host'] }}:6443" \
          --token="{{ k3s_token }}"
      when: not k3s_binary.stat.exists

- name: Install kube-vip on servers
  hosts: k3s_servers
  become: true
  run_once: true
  tasks:
    - name: Create kube-vip manifest directory
      file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        mode: '0755'

    - name: Deploy kube-vip DaemonSet
      copy:
        content: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: kube-vip
            namespace: kube-system
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: kube-vip
          rules:
            - apiGroups: [""]
              resources: ["services", "endpoints", "nodes"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["coordination.k8s.io"]
              resources: ["leases"]
              verbs: ["get", "list", "watch", "create", "update"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: kube-vip
          subjects:
            - kind: ServiceAccount
              name: kube-vip
              namespace: kube-system
          roleRef:
            kind: ClusterRole
            name: kube-vip
            apiGroup: rbac.authorization.k8s.io
          ---
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: kube-vip
            namespace: kube-system
          spec:
            selector:
              matchLabels:
                app: kube-vip
            template:
              metadata:
                labels:
                  app: kube-vip
              spec:
                serviceAccountName: kube-vip
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                        - matchExpressions:
                            - key: node-role.kubernetes.io/control-plane
                              operator: Exists
                tolerations:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
                    effect: NoSchedule
                hostNetwork: true
                containers:
                  - name: kube-vip
                    image: ghcr.io/kube-vip/kube-vip:v0.8.7
                    args:
                      - manager
                    env:
                      - name: vip_arp
                        value: "true"
                      - name: port
                        value: "6443"
                      - name: vip_interface
                        value: eth0
                      - name: vip_cidr
                        value: "32"
                      - name: cp_enable
                        value: "true"
                      - name: cp_namespace
                        value: kube-system
                      - name: vip_leaderelection
                        value: "true"
                      - name: vip_leasename
                        value: kube-vip-leader
                      - name: vip_leaseduration
                        value: "5"
                      - name: vip_renewdeadline
                        value: "3"
                      - name: vip_retryperiod
                        value: "1"
                      - name: address
                        value: "{{ k3s_vip }}"
                    securityContext:
                      capabilities:
                        add:
                          - NET_ADMIN
                          - NET_RAW
        dest: /var/lib/rancher/k3s/server/manifests/kube-vip.yaml
        mode: '0644'

- name: Verify cluster
  hosts: k3s_servers[0]
  become: true
  tasks:
    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -v "NotReady" | wc -l
      register: ready_nodes
      until: ready_nodes.stdout | int >= 4
      retries: 30
      delay: 10

    - name: Display cluster status
      command: kubectl get nodes -o wide
      register: cluster_status

    - name: Show cluster status
      debug:
        var: cluster_status.stdout_lines

    - name: Fetch kubeconfig
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /tmp/k3s.yaml
        flat: yes

- name: Configure kubectl on ansible node
  hosts: localhost
  connection: local
  tasks:
    - name: Create .kube directory
      file:
        path: ~/.kube
        state: directory
        mode: '0700'

    - name: Copy kubeconfig
      copy:
        src: /tmp/k3s.yaml
        dest: ~/.kube/config
        mode: '0600'

    - name: Update kubeconfig server address to VIP
      replace:
        path: ~/.kube/config
        regexp: '127\.0\.0\.1'
        replace: '{{ k3s_vip }}'

    - name: Verify kubectl access
      command: kubectl get nodes
      register: nodes_output

    - name: Show accessible nodes
      debug:
        var: nodes_output.stdout_lines
